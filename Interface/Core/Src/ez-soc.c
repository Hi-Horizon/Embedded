/*
 * ez-soc.c
 *
 *  Created on: 12 Sep 2025
 *      Author: senne
 */


#include <ez-soc.h>

uint16_t Battery_voltages[] = {
  3919,  3961,  3999,  4035,  4070,  4102,  4134,  4163,  4191,  4216,
  4240,  4263,  4284,  4305,  4325,  4342,  4359,  4375,  4390,  4407,
  4423,  4439,  4455,  4472,  4488,  4505,  4521,  4537,  4552,  4567,
  4581,  4596,  4610,  4623,  4637,  4650,  4663,  4676,  4690,  4702,
  4714,  4727,  4739,  4752,  4761,  4772,  4782,  4791,  4800,  4808,
  4816,  4823,  4831,  4838,  4844,  4851,  4858,  4865,  4872,  4879,
  4887,  4895,  4904,  4911,  4920,  4928,  4935,  4943,  4949,  4957,
  4963,  4971,  4978,  4985,  4991,  4997,  5004,  5011,  5017,  5023,
  5029,  5036,  5042,  5049,  5055,  5062,  5069,  5075,  5083,  5089,
  5096,  5104,  5110,  5118,  5125,  5133,  5139,  5147,  5154,  5161,
  5168,  5175,  5182,  5189,  5196,  5203,  5210,  5216,  5222,  5229,
  5236,  5242,  5250,  5255,  5262,  5268,  5274,  5280,  5286,  5292,
  5298,  5303,  5309,  5314,  5320,  5324,  5330,  5335,  5339,  5344,
  5349,  5354,  5358,  5363,  5368,  5373,  5379,  5384,  5390,  5397,
  5403,  5410,  5417,  5425,  5432,  5440,  5449,  5458,  5467,  5476,
  5486,  5496,  5506,  5516,  5525,  5535,  5543,  5552,  5560,  5567,
  5574,  5581,  5586,  5591,  5596,  5601,  5604,  5607,  5610,  5613,
  5615,  5619,  5621,  5623,  5625,  5628,  5630,  5632,  5634,  5636,
  5637,  5641,  5642,  5644,  5647,  5650,  5652,  5654,  5659,  5662,
  5666,  5671,  5676,  5683,  5691,  5700,  5711,  5724,  5741,  5766,
};

uint16_t percentages[] = {
  0,  38,  77,  117,  156,  196,  237,  278,  318,  360,
  401,  443,  485,  527,  569,  612,  654,  697,  740,  783,
  827,  870,  914,  958,  1002,  1046,  1090,  1134,  1179,  1224,
  1268,  1313,  1359,  1404,  1449,  1495,  1541,  1586,  1632,  1678,
  1725,  1771,  1817,  1864,  1910,  1957,  2004,  2051,  2098,  2145,
  2192,  2240,  2287,  2334,  2382,  2429,  2477,  2525,  2573,  2620,
  2668,  2716,  2764,  2812,  2861,  2909,  2957,  3006,  3054,  3103,
  3152,  3200,  3249,  3298,  3347,  3396,  3445,  3494,  3543,  3592,
  3642,  3691,  3740,  3790,  3840,  3889,  3939,  3989,  4038,  4088,
  4138,  4188,  4238,  4289,  4339,  4389,  4439,  4490,  4540,  4591,
  4642,  4692,  4743,  4794,  4845,  4896,  4947,  4998,  5049,  5101,
  5152,  5203,  5255,  5306,  5358,  5410,  5461,  5513,  5565,  5617,
  5669,  5721,  5773,  5825,  5877,  5929,  5981,  6034,  6086,  6138,
  6191,  6243,  6296,  6348,  6401,  6454,  6507,  6559,  6612,  6665,
  6718,  6771,  6824,  6877,  6931,  6984,  7037,  7091,  7144,  7198,
  7252,  7306,  7360,  7414,  7468,  7522,  7576,  7631,  7685,  7740,
  7795,  7849,  7904,  7959,  8014,  8069,  8124,  8178,  8234,  8289,
  8344,  8399,  8454,  8509,  8564,  8619,  8675,  8730,  8785,  8840,
  8896,  8951,  9006,  9062,  9117,  9172,  9228,  9283,  9339,  9394,
  9450,  9505,  9561,  9617,  9673,  9728,  9784,  9840,  9897,  9953,

};

// Find index of closest x in x_vals to target.
// Assumes x_vals is sorted in ascending order.
int binary_search_closest(const uint16_t *x_vals, int len, uint16_t target) {
    int low = 0;
    int high = (int)len - 1;

    while (low <= high) {
        int mid = (low + high) / 2;

        if (x_vals[mid] == target) {
            return mid; // exact match
        } else if (x_vals[mid] < target) {
            low = mid + 1;
        } else {
            high = mid - 1;
        }
    }

    // low is now the index of the first element greater than target
    // high is the index of the last element less than target
    if (low == 0) return 0;
    if (low >= (int)len) return (int)len - 2;

    return low - 1;
}


float linearInterpolation(int index1, int index2, uint16_t VBatInt) {
    float slope = ((float )(percentages[index2] - percentages[index1])/(float)(Battery_voltages[index2] - Battery_voltages[index1]));
    return percentages[index1] + slope*(VBatInt - Battery_voltages[index1]);
}

float calculateSOC(float Vbat) {
	uint16_t VbatInt = (uint16_t) floor(Vbat*100);
	int closestInd = binary_search_closest(Battery_voltages, 200, VbatInt);
	return linearInterpolation(closestInd, closestInd + 1, VbatInt)/100.0f;
}

